\section{Початкові умови}

\subsection{Породжувальна модель обличчя}

\subsubsection{Побудова}

За допомогою високоточного 3D сканеру
було зафіксовано $100$ чоловічих і $100$ жіночих облич.
Це люди віком від $8$ до $62$ років ($25$ в середньому),
вагою від $40$ до $123$ кілограмів ($66$ в середньому).

Щоб зважена сума облич теж була обличчям,
потрібно знайти відповідність між вершинами моделей різних облич.
Тобто, оскільки модель складається з впорядкованого набору вершин,
точка, яка відповідає, наприклад, за горбинку на носі,
повинна бути на одній і тій самій позиції в масиві кожної моделі.
Для цього була використана модифікація
ітеративного алгоритму найближчих точок ICP \cite{AmbergRV07}.
Після цього достатньо відмітити опорні точки обличчя лише на одній моделі,
щоб вони були відомі на всіх інших,
у тому числі на похідних обличчях.

Розраховується середня модель обличчя як середнє арифметичнє по всім моделям
\begin{equation*}
  \overline{f}_v
  = \frac{\sum\limits_{f \in F} f_v}{\left| F \right|},\qquad
  v \in V,
\end{equation*}
де $V$ --- множина вершин, $F$ --- множина облич,
$f_v$ --- координати вершини $v$ в обличчі $f$.
Середня модель теж є обличчям завдяки попередньому кроку співставлення вершин.

Останній етап, який нас цікавить,
це обробка даних за допомогою методу головних компонент \cite{Aivazyan:1989}.
На вході матриця, кожному стовбцю якої відповідає координата вершини,
а стрічці --- обличчя.
На перетині $f$ стрічки і $v_i$ стовбця знаходиться значення $i$ компоненти
координат вершини $v$ обличчя $f$
\begin{equation*}
  M = \begin{bmatrix}
    M_{v_x^1}^{f^1} & M_{v_y^1}^{f^1} & M_{v_z^1}^{f^1} & M_{v_x^2}^{f^1}
      & \dots                         & M_{v_y^m}^{f^1} & M_{v_z^m}^{f^1} \\
    M_{v_x^1}^{f^2} & M_{v_y^1}^{f^2} & M_{v_z^1}^{f^2} & M_{v_x^2}^{f^2}
      & \dots                         & M_{v_y^m}^{f^2} & M_{v_z^m}^{f^2} \\
    \vdots          & \vdots          & \vdots          & \vdots
      & \ddots                        & \vdots          & \vdots \\
    M_{v_x^1}^{f^n} & M_{v_y^1}^{f^n} & M_{v_z^1}^{f^n} & M_{v_x^2}^{f^n}
      & \dots                         & M_{v_y^m}^{f^n} & M_{v_z^m}^{f^n} \\
  \end{bmatrix}.
\end{equation*}
На виході маємо дисперсії головних компонент
і лінійне перетворення $U$ коваріаційної матриці $\widetilde{M}$,
яке робіть $U \cdot \widetilde{M} \cdot U^{-1}$ діагональною.

Оскільки маємо головні компоненти,
нове обличчя отримується не як зважене середнє кількох облич,
а як сума середнього обличчя та вектору параметрів $x$
помноженого на матрицю $U$
\begin{equation*}
  M\left( x \right) = \overline{f} + x \cdot U.
\end{equation*}

Переваги головних компонент:
\begin{enumerate}
  \item для зменшення обчислювальних витрат можна обирати не всі параметри,
    а лише кілька перших,
    бо вони мають найбільшу дисперсію
    і несуть в собі більшу частину інформації;
  \item згідно з центральною граничною теоремою
    розподіл параметрів вважається нормальним,
      що зручно при моделюванні та обчисленнях:
  \begin{enumerate}
    \item фактично відсутні обмеження на параметри моделі на відміну від
      зваженого середнього, де сума параметрів повинна дорівнювати $1$;
    \item за побудовою випадкові величини мають нульове середнє значення
      та діагональну коваріаційну матрицю;
    \item якщо нормувати параметри (перенести їх дисперсію в матрицю $U$),
      отримаємо набір незалежних випадкових величин
      розподілених за стандартним нормальним законом.
  \end{enumerate}
\end{enumerate}

\subsubsection{Використання}

Введемо множину вершин обличчя $V$.
Кожна вершина має певні координати в тривимірному просторі $\mathbb{R}^3$.
Модель обличчя --- відображення,
яке кожній вершині $v$ ставить у відповідність її координати
\begin{equation*}
  M: V \rightarrow \mathbb{R}^3.
\end{equation*}
Породжувальна модель обличчя --- відображення,
яке кожному набору параметрів $x$ ставить у відповідність модель $m$
\begin{equation*}
  G: X \rightarrow M.
\end{equation*}
Координати $g$ вершини $v$ моделі, згенерованої з параметрами $x$, позначимо
\begin{equation*}
  G_v\left( x \right) = m_v = g.
\end{equation*}

Координати кожної вершини $v$ породжувальної моделі отримуються шляхом
перемноження компонент параметру $x$ на відповідний коефіцієнт $\lambda^v$,
отриманий за допомогою методу головних компонент,
та додавання результату до середнього положення поточної вершини
\begin{equation*}
  G_v\left( x \right) = g_0^v + \sum_{i \in 1}^n \lambda_i^v \cdot x_i,
  \qquad v \in V.
\end{equation*}

\subsection{Зображення}

Позначимо множину зображень $T$ і множину кольорів $C$.
Введемо множину пікселів зображення $I$.
Зображення $t \in T$ є відображення з множини пікселів на множину їх значень
\begin{equation*}
  t: I \rightarrow C.
\end{equation*}
Колір пікселя $i$ в зображенні $t$ позначимо як $t_i$.

Взагалі кажучи, $I$ --- множина індексів матриць однакового розміру
\begin{equation*}
  I = \left\{ \left\langle i, j \right\rangle
    \;\middle|\; i = 1..h,\; j = 1..w \right\}.
\end{equation*}
Зазвичай використовуються зображення розміром від
$100 \times 100 = 10^4$ пікселів.
Проте сучасні камери на фотоапаратах, смартфонах та інших пристроях
можуть зробити зображення площею кілька мільйонів пікселів і більше.
При використанні $2^8 = 256$ градацій сірого маємо
$2^{8 \cdot 10^4} \approx 10^{24 \cdot 10^3}$
різних зображень розміром $100 \times 100$, тобто неймовірно багато.

Тривимірна модель обличчя визначається не тільки набором $n$ дійсних параметрів
з множини $X = \mathbb{R}^n$.
Є додаткові параметри, що відіграють важливу роль при візуалізації,
проте не потрібні в результаті --- поворот, масштаб, перспектива тощо.
Введемо відображення $\theta^M \in \Theta^M$,
що застосовує необхідні перетворення до точки в тривимірному просторі
\begin{equation*}
  \theta^M: \mathbb{R}^3 \rightarrow \mathbb{R}^3.
\end{equation*}
Функцією, що перетворює набір параметрів на зображення, є відображення
\begin{equation*}
  f: \Theta^M \times X \rightarrow T.
\end{equation*}
Зображення $t$, згенероване з параметрами $\theta^M$ та $x$, позначатимемо
\begin{equation*}
  f_{\theta^M} \left( x \right) = t.
\end{equation*}
В подальших записах індекс $\theta^M$ записувати не будемо,
коли з контексту буде зрозуміло, які перетворення застосовуються до моделі.

Для подальших обчислень введемо функцію $h$ (hidden),
яка приймає значення $0$,
якщо в даній точці зображення є піксель обличчя,
та дорівнює $1$ у протилежному випадку
\begin{align*}
  h: I \times \Theta^M \times X \rightarrow \left\{ 0, 1 \right\}.
\end{align*}
Введемо короткий запис для інверсії маски
\begin{align*}
  \overline{h}^{\theta^M}_i\left( x \right)
  = 1 - h^{\theta^M}_i\left( x \right),\qquad
  i \in I.
\end{align*}

\subsection{Опорні точки}

Оскільки відповідні вершини всіх моделей мають однакове семантичне значення,
за рахунок чого простір згенерованих облич і є опуклим,
можна скористатися інформацією деяких особливих з точки зору людини точок.
Такі точки як краї губ, носа, очей і таке інше назвемо опорними точками.
Множину обраних точок в контексті певної задачі позначатимемо
\begin{equation*}
  L \subset V.
\end{equation*}
Положення $u$ опорної точки $l \in L$ у моделі $m$ позначимо
\begin{equation*}
  m_{l} = u.
\end{equation*}
Відображення тривимірної точки,
до якої застосовано перетворення $\theta^M$,
\begin{equation*}
  P_2: \Theta^M \times \mathbb{R}^3 \rightarrow I.
\end{equation*}
Проекцію $p$ точки $v$ моделі $m$ на площину запишемо
\begin{equation*}
  P^2_{\theta^M}\left( m_v \right) = p.
\end{equation*}
Також, коли з контексту зрозуміло значення $\theta^M$,
позначатимемо без нижнього індексу
\begin{equation*}
  P^2\left( m_v \right) = p.
\end{equation*}
Введемо відображення $\theta^L$,
що для певної опорної точки $l$
дає координати цієї точки на даному зображенні $t$
\begin{equation*}
  \theta^L: L \times T \rightarrow I.
\end{equation*}
Координати опорної точки $l$ на зображенні $t$ позначимо
\begin{equation*}
  \theta_l^L\left( t \right) = i.
\end{equation*}
Аргумент використовувати не будемо, коли з контексту буде зрозуміло,
про яке зображення йде мова.

Потрібна метрика,
що буде відображати віддаленість двох точок на множині пікселів зображення.
Той факт,
що дві точки $i$ і $i'$ знаходяться одна від одної на відстані $\mu$,
запишемо як
\begin{equation*}
  \left\| i - i' \right\| = \mu.
\end{equation*}
Оскільки $i$ --- впорядкована пара чисел,
що відповідають координатам певного пікселя,
природнім чином можно впровадити звичайну евклідову метрику
для розрахунку відстані між двома точками зображення.

\subsection{Фон}
Якщо зображення складається не лише з пікселів обличчя,
обов'язково є фон.
Він може бути відомим, наприклад,
якщо заздалегіть було отримано зображення фону,
на якому буде відбуватися фотозйомка.
У загальному випадку він є невідомою величиною,
розподіл якої також невідомий,
а може не існувати зовсім.
Позначимо його як зображення $\theta^B$
\begin{align*}
  \theta^B \in T.
\end{align*}
Фон має такий самий розмір, як і вхідне зображення.

\subsection{Шум}

Вважаємо,
що на вхідне зображення накладено шум $\eta$,
що є вектором незалежних випадкових величин,
розподілених за центрованим нормальним законом
з однаковою невідомою дисперсією $\sigma_t^2$.
Колір пікселя $i$
\begin{equation*}
  t_i = f_i\left( x \right) \cdot \overline{h}_i\left( x \right)
    + \theta_i^B \cdot h_i\left( x \right) + \eta_i,\qquad
  \eta_i \sim \mathcal{N}\left( 0, \sigma^2_t\right), \qquad
  i \in I.
\end{equation*}

\subsection{Оцінка опорних точок}

Замість реального положення опорних точок $\theta^L$
будемо розглядати оцінку $\hat{\theta}^L$,
яка отримана з похибкою,
що має центрований ґаусовий розподіл
з дисперсією $\sigma^2_L$
\begin{equation*}
  \hat{\theta}^L = \theta_t^L\left( l \right) + \zeta_l,
  \qquad \zeta_l \sim \mathcal{N}\left( 0, \sigma_L^2 \right).
\end{equation*}
Позначимо відхилення проекції опорних точок моделі
від їх оцінки
\begin{align*}
  \Delta\left( x \right)
  = P^2_{\theta^M}\left( G_L\left( x \right) \right) - \hat{\theta}^L.
\end{align*}

\subsection{Оцінка сегменту обличчя}

Функцію $h$ можно позначити як ймовірність того,
що даний піксель $i$ належить обличчю.
За відомих $x$ і $\theta^M$ ці ймовірності визначені однозначно
і приймають значення $0$ або $1$
\begin{equation*}
  h_i^{\theta^M}\left( x \right)
  = \mathbb{P}_{\theta^M}\left( i \in I' \mcond x \right).
\end{equation*}
Зображення може містити декілька облич,
тому перевірка належністі одного пікселя $i$ множині пікселів обличчя $I'$
не має сенсу.
Треба перевіряти усю сукупність пікселів $I'$ на те,
чи знаходиться там обличчя.
Оцінкою маски може слугувати набір ймовірностей,
що побудований на основі зображення $t$
\begin{equation*}
  \hat{h}^{\theta^M}\left( x \right)
  = \mathbb{P}\left( I' \mcond t \right).
\end{equation*}

\subsection{Результуюча ймовірність}

Ймовірність того,
що буде пред'явлено зображення $t$ з параметрами $x$
при відомих перетвореннях $\theta^M$
і оцінці положень опорних точок $\hat{\theta}^L$, є сумісною ймовірністю
\begin{equation*}
  p_{\theta}
  = \mathbb{P}_{\theta}\left\{
    f_{\theta^M}\left( \xi \right) + \eta = t,
    \zeta = \Delta\left( \xi \right),
    \xi = x
  \right\}.
\end{equation*}
З визначення умовної ймовірності випливає
\begin{equation*}
  p_{\theta}
  = \mathbb{P}_{\theta}\left\{
      f_{\theta^M}\left( \xi \right) + \eta = t,
      \zeta = \Delta\left( \xi \right)
      \;\middle|\; \xi = x \right\}
    \cdot \mathbb{P}\left( \xi = x \right)
\end{equation*}
Позбавимося умовної ймовірності, замінивши $\xi$ на $x$
і розіб'ємо першу ймовірність на добуток двох ймовірностей,
вважаючи, що похибка оцінки опорних точок не залежить від шуму на зображенні
\begin{equation*}
  p_{\theta}
  = \mathbb{P}_{\theta^M}\left( \eta = t - f_{\theta^M}\left( x \right) \right)
    \cdot \mathbb{P}_{\theta}\left\{
      \zeta = \Delta\left( x \right)
    \right\}
    \cdot \mathbb{P}\left( \xi = x \right).
\end{equation*}

Далі будемо позначати сумісну ймовірність без $\theta$,
коли з контексту буде зрозуміло,
які параметри використані
\begin{align*}
  \mathbb{P}\left( t, x \right) = p_{\theta}.
\end{align*}
